import { derived, writable } from 'svelte/store';

const defaultSettings = {
  filters: {
    // replies: 'filterOut',
    // nativeretweets: 'filterOut'
  },
  seeFollow: false,
  cardPoll: false
}
const localStorageKey = 'filters'
let storedSettings = localStorage.getItem(localStorageKey);
storedSettings = storedSettings ? JSON.parse(storedSettings) : defaultSettings
export const settings = writable(storedSettings);

settings.subscribe(value => {
  localStorage.setItem(localStorageKey, JSON.stringify(value));
});

export const tweetURL = derived(settings, obj => {
  let final = ''
  let header = 'https://mobile.twitter.com'
  Object.keys(obj).forEach(k => {
    if (k === 'filters') return
    if (k === 'cardPoll') return
    if (k === 'seeFollow') return
    if (k === 'usernameMode') return
    if (k === 'from') {
      if (obj.usernameMode === 'userfrom') {
        final = final.concat(`from:${obj.from} `)
      } else {
        final = final.concat(`-from:${obj.from} twitter.com/${obj.from} `)
      }
      return
    }
    if (k === 'searchKeyword') {
      // special
      final = (obj[k] || '').concat(' ').concat(final)
    } else if (obj[k]) {
      final = final.concat(`${k}:${obj[k]} `)
    }
  })
  Object.entries(obj.filters).forEach(([filter, filterState]) => {
    if (filterState === 'filterFor') final = final.concat(`filter:${filter} `)
    // if (filterState === 'filterOut') final = final.concat(`!filter:${filter} `) // seems to have changed
    if (filterState === 'filterOut') final = final.concat(`-filter:${filter} `)
  })
  if (obj.seeFollow) {
    delete obj.seeFollow
    final = final.concat(`filter:follows `)
    header = 'https://mobile.twitter.com'
  }
  if (obj.cardPoll) {
    final = final.concat(`card_name:poll2choice_text_only OR card_name:poll3choice_text_only OR card_name:poll4choice_text_only OR card_name:poll2choice_image OR card_name:poll3choice_image OR card_name:poll4choice_image `)
  }
  if (obj.minLikes > 0) final = final.concat(`min_faves:${obj.minLikes} `)
  if (obj.minRTs > 0) final = final.concat(`min_retweets:${obj.minRTs} `)
  console.log(obj.cardPoll, obj, final)
  // return `https://mobile.twitter.com/search?src=typd&f=live&q=${encodeURIComponent(final)}`
  return `${header}/search?f=tweets&q=${encodeURIComponent(final)}`
})
